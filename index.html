<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Project Location Tracker</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Sarabun:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root { 
            --primary-color: #3B82F6; /* Blue 500 */
            --secondary-color: #6B7280; /* Gray 500 */
            --danger-color: #EF4444; /* Red 500 */
            --warning-color: #F59E0B; /* Amber 500 */
            --success-color: #10B981; /* Emerald 500 */
            --light-gray: #F9FAFB;
            --medium-gray: #E5E7EB;
        }
        html, body { 
            height: 100%; 
            margin: 0; 
            font-family: 'Inter', 'Sarabun', sans-serif; 
            background-color: var(--light-gray); 
        }
        .app-view { display: none; }
        .app-view.active { display: block; }
        body { display: flex; align-items: flex-start; justify-content: center; padding: 1rem; }
        .main-card { 
            background-color: white; 
            border-radius: 1rem; /* Increased */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1); /* Improved Shadow */
            transition: all 0.2s ease-in-out; 
            width: 100%;
        }
        .project-card {
            background-color: white; 
            border: 1px solid var(--medium-gray);
            border-radius: 1rem; /* Increased */
            box-shadow: 0 1px 2px 0 rgba(0,0,0,0.05);
            transition: all 0.2s ease-in-out;
        }
        .project-card:hover { 
            transform: translateY(-4px); 
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border-color: var(--primary-color);
        }
        #map, #dashboard-map { height: 250px; width: 100%; border-radius: 0.75rem; /* Increased */ overflow: hidden; z-index: 10; }
        #messageBox, #loadingSpinner { position: fixed; top: 1rem; left: 50%; transform: translateX(-50%); z-index: 9999; padding: 0.75rem 1.25rem; border-radius: 1rem; /* Increased */ box-shadow: 0 4px 6px rgba(0,0,0,0.1); font-size: 1rem; font-weight: 500; display: flex; align-items: center; gap: 0.5rem; }
        #loadingSpinner { display: none; background-color: #111827; color: white; }
        #messageBox { display: none; }
        .modal-overlay { position: fixed; inset: 0; background-color: rgba(17, 24, 39, 0.6); display: none; align-items: center; justify-content: center; z-index: 9998; backdrop-filter: blur(4px); }
        .modal-content { background-color: white; border-radius: 1rem; /* Increased */ padding: 1.5rem; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04); max-width: 400px; width: 90%; text-align: center; }
        input[type="text"], input[type="password"], select, textarea { /* Added textarea */
            width: 100%; padding: 0.6rem 0.75rem; font-size: 0.875rem; 
            border: 1px solid #D1D5DB; border-radius: 0.75rem; /* Increased */
            transition: border-color 0.2s, box-shadow 0.2s;
            background-color: white;
        }
        input[type="text"]:focus, input[type="password"]:focus, select:focus, textarea:focus { /* Added textarea */
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.4);
        }
        .action-row { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
        }
        .btn { 
            padding: 0.6rem 1rem; font-size: 0.875rem; font-weight: 500;
            border-radius: 0.75rem; /* Increased */ border: 1px solid transparent; 
            transition: all 0.2s ease-in-out; 
            display: flex; align-items: center; justify-content: center; gap: 0.5rem; cursor: pointer;
            box-shadow: 0 1px 2px 0 rgba(0,0,0,0.05);
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); }
        .btn-icon { padding: 0.6rem; }
        .btn-primary { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
        .btn-secondary { background-color: white; color: var(--secondary-color); border-color: var(--medium-gray); }
        .btn-secondary:hover { background-color: #F3F4F6; }
        .btn-danger { background-color: var(--danger-color); color: white; border-color: var(--danger-color); }
        .btn-warning { background-color: var(--warning-color); color: white; border-color: var(--warning-color); }
        .btn-success { background-color: var(--success-color); color: white; border-color: var(--success-color); }
        table { border-collapse: collapse; text-align: left; width: 100%; }
        thead { background-color: #F9FAFB; }
        th, td { padding: 0.75rem; border-bottom: 1px solid var(--medium-gray); font-size: 0.875rem; }
        th { font-weight: 600; color: #374151; }
        td { color: #4B5563; word-break: break-word; }
        tr:last-child td { border-bottom: none; }
        .table-scroll { max-height: calc(100vh - 20rem); overflow-y: auto; border: 1px solid var(--medium-gray); border-radius: 1rem; /* Increased */ }
        .hidden-col { display: none; }
        .pending-icon { color: var(--warning-color); margin-left: 4px; }
        .dragging { opacity: 0.5; }
        
        /* Custom Admin Menu Button Color */
        #admin-menu-view .btn-primary {
            background-color: #5087f7;
            border-color: #5087f7;
        }
    </style>
</head>
<body>
    <div id="app-container" class="w-full max-w-md mx-auto">
        <!-- View 1: Project Selection -->
        <div id="project-selection-view" class="app-view">
            <div class="main-card p-4 sm:p-6">
                <!-- Main Title -->
                <div class="text-center mb-4">
                    <h1 class="text-2xl sm:text-3xl font-bold flex items-center justify-center gap-2" style="color: #5087f7;">
                        <i class="fas fa-map-marker-alt"></i>
                        <span>Location Tracker</span>
                    </h1>
                </div>
                
                <!-- Search and Manage Section -->
                <div class="mb-6">
                    <div class="relative">
                        <input id="project-search-input" type="text" placeholder="Search projects..." class="w-full !pl-10 p-2 border border-gray-300 rounded-lg">
                        <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    </div>
                </div>
                
                <!-- Subtitle and Count Section -->
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <p id="project-count" class="text-sm text-gray-500 font-semibold">Total Projects: 0</p>
                    </div>
                    <button id="manage-projects-btn" class="btn btn-secondary btn-icon text-sm" title="Manage Projects"><i class="fas fa-cog"></i></button>
                </div>

                <!-- Project List -->
                <div id="project-list" class="flex flex-col space-y-3">
                    <!-- Project cards will be injected here -->
                </div>
            </div>
        </div>

        <!-- View: Admin Menu -->
        <div id="admin-menu-view" class="app-view">
            <div class="main-card p-4 sm:p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl sm:text-2xl font-bold text-gray-800">Admin Menu</h2>
                    <button id="menu-back-to-selection-btn" class="btn btn-secondary text-sm"><i class="fas fa-arrow-left"></i> Back</button>
                </div>
                <div class="space-y-4">
                    <button id="goto-manage-projects-btn" class="w-full btn btn-primary text-lg p-6 justify-start">
                        <i class="fas fa-edit w-8"></i>
                        <span>Manage Projects</span>
                    </button>
                    <button id="goto-dashboards-btn" class="w-full btn btn-primary text-lg p-6 justify-start">
                        <i class="fas fa-chart-bar w-8"></i>
                        <span>Dashboard</span>
                    </button>
                    <button id="goto-id-field-btn" class="w-full btn btn-primary text-lg p-6 justify-start">
                        <i class="fas fa-id-card w-8"></i>
                        <span>Manage IDs</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- View 2: CMS/Admin -->
        <div id="admin-view" class="app-view">
            <div class="main-card p-4 sm:p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl sm:text-2xl font-bold text-gray-800">Manage Projects</h2>
                    <button id="back-to-menu-btn" class="btn btn-secondary text-sm"><i class="fas fa-arrow-left"></i> Back</button>
                </div>
                <form id="add-project-form" class="flex gap-2 mb-4"><input id="new-project-name" type="text" class="flex-grow" placeholder="New project name" required><button type="submit" class="btn btn-primary"><i class="fas fa-plus"></i> Add</button></form>
                <div id="admin-project-list" class="space-y-2">
                    <!-- Admin project list will be injected here -->
                </div>
                <!-- Save Order Button -->
                <button id="save-project-order-btn" class="hidden btn btn-success w-full mt-4"><i class="fas fa-save"></i> Save Order</button>
            </div>
        </div>

        <!-- View: ID Field -->
        <div id="id-field-view" class="app-view">
            <div class="main-card p-4 sm:p-6 h-full flex flex-col">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl sm:text-2xl font-bold text-gray-800">Manage IDs</h2>
                        <div class="space-x-2">
                            <button id="edit-id-field-btn" class="btn btn-secondary btn-icon text-sm" title="Edit names"><i class="fas fa-pencil-alt"></i></button>
                            <button id="save-id-field-btn" class="hidden btn btn-success text-sm">Save</button>
                            <button id="cancel-id-field-btn" class="hidden btn btn-secondary text-sm">Cancel</button> 
                        </div>
                    </div>
                    <div class="mb-4">
                        <input id="id-field-search" type="text" placeholder="Search by ID or name..." class="w-full">
                    </div>
                    <div class="flex-grow table-scroll">
                        <table class="w-full">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                </tr>
                            </thead>
                            <tbody id="id-field-table-body">
                                <!-- Data will be populated by JS -->
                            </tbody>
                        </table>
                    </div>
                    <button id="id-field-back-to-menu-btn" class="btn btn-secondary text-sm mt-4"><i class="fas fa-arrow-left"></i> Back</button>
            </div>
        </div>


        <!-- View: Dashboard -->
        <div id="dashboard-view" class="app-view">
            <div class="main-card p-4 sm:p-6 space-y-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-xl sm:text-2xl font-bold text-gray-800">Dashboard</h2>
                    <button id="dashboard-back-to-menu-btn" class="btn btn-secondary text-sm"><i class="fas fa-arrow-left"></i> Back</button>
                </div>
                <div>
                    <label for="dashboard-project-selector" class="block text-sm font-medium text-gray-700 mb-1">Select Project</label>
                    <select id="dashboard-project-selector"></select>
                </div>
                <div id="dashboard-content" class="hidden space-y-6">
                    <!-- KPIs -->
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-gray-50 p-4 rounded-xl text-center">
                            <p class="text-sm text-gray-500">Total Check-ins</p>
                            <p id="kpi-total-checkins" class="text-2xl font-bold text-primary-color">0</p>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-xl text-center">
                            <p class="text-sm text-gray-500">Employees</p>
                            <p id="kpi-unique-employees" class="text-2xl font-bold text-primary-color">0</p>
                        </div>
                    </div>
                    <!-- Map -->
                    <div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-2">Location Overview</h3>
                            <div id="dashboard-map"></div>
                    </div>
                    <!-- Employee Summary Table -->
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">Employee Summary</h3>
                        <div class="table-scroll">
                            <table class="w-full">
                                <thead>
                                    <tr>
                                        <th id="dashboardHeaderIdField">ID</th>
                                        <th>Name</th>
                                        <th class="text-center">Check-ins</th>
                                    </tr>
                                </thead>
                                <tbody id="dashboard-summary-table">
                                    <!-- Summary rows will be injected here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                    <div id="dashboard-placeholder" class="text-center text-gray-500 py-10">
                        <p>Please select a project to see the summary.</p>
                    </div>
            </div>
        </div>
        
        <!-- View 3: Location Tracker -->
        <div id="tracker-view" class="app-view">
            <div class="main-card p-4 space-y-4">
                <div class="flex justify-between items-center">
                    <button id="home-button" class="btn btn-secondary btn-icon" title="Home"><i class="fas fa-home"></i></button>
                    <h3 id="tracker-title" class="text-lg sm:text-xl font-semibold text-gray-800 text-center truncate"></h3>
                    <button id="customizeLabelsBtn" class="btn btn-secondary btn-icon" title="Customize Labels"><i class="fas fa-magic"></i></button>
                </div>
                <div id="map"></div>
                <div class="p-3 rounded-xl bg-blue-50 border border-blue-200">
                    <div class="flex justify-center items-center gap-4 text-xs font-medium text-gray-700">
                        <p>Latitude: <span id="lat" class="font-bold text-blue-600">--</span></p>
                        <p>Longitude: <span id="lng" class="font-bold text-blue-600">--</span></p>
                        <button id="currentLocationButton" class="p-2 rounded-lg bg-purple-500 text-white hover:bg-purple-600 transition" title="Use Current Location"><i class="fas fa-map-marker-alt"></i></button>
                    </div>
                </div>
                <div class="space-y-3">
                    <div class="flex gap-2"> <!-- Flex container for Employee ID and Survey ID -->
                        <div class="input-row flex-grow">
                            <label id="employeeIdLabel" for="employeeIdInput">Employee ID</label>
                            <input id="employeeIdInput" type="text" placeholder="Employee ID" />
                        </div>
                        <div class="input-row flex-grow">
                            <label id="surveyIdLabel" for="surveyIdInput">Survey ID</label>
                            <input id="surveyIdInput" type="text" placeholder="Survey ID" />
                        </div>
                    </div>
                    <div class="input-row">
                        <label for="locationSearchInput">Search Location</label>
                        <div class="flex-1 flex">
                            <div class="relative w-full">
                                <input id="locationSearchInput" type="text" placeholder="e.g., Bangkok" autocomplete="off" class="!rounded-r-none" />
                                <i id="clearSearchIcon" class="fas fa-times absolute z-10 top-1/2 right-3 -translate-y-1/2 cursor-pointer text-gray-400" style="display:none;"></i>
                                <div id="autocompleteList" class="absolute top-full left-0 right-0 bg-white border z-50 rounded-b-lg hidden"></div>
                            </div>
                            <button id="searchLocationButton" class="btn btn-secondary btn-icon !rounded-l-none -ml-px">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div id="normalActionButtons" class="action-row">
                    <button id="saveButton" class="btn btn-success"><i class="fas fa-save"></i><span>Save</span></button>
                    <button id="uploadButton" class="btn btn-warning"><i class="fas fa-upload"></i><span>Upload</span></button>
                    <button id="exportCsvButton" class="btn btn-primary"><i class="fas fa-file-export"></i><span>Export</span></button>
                </div>
                <div id="editActionButtons" class="action-row hidden"><button id="confirmEditButton" class="btn btn-warning">Save Changes</button><button id="cancelEditButton" class="btn btn-secondary">Cancel</button></div>
                <div class="relative mt-4">
                    <div class="flex justify-between items-center bg-gray-50 p-3 rounded-t-xl border-b border-gray-200">
                        <h4 class="font-semibold text-sm">Saved Locations</h4>
                    </div>
                    <div class="table-scroll"><table class="w-full"><thead><tr><th>No.</th><th id="tableHeaderEmployeeId">Employee ID</th><th id="tableHeaderSurveyId">Survey ID</th><th>Timestamp</th><th>Map</th><th>Actions</th></tr></thead><tbody id="savedLocationsTableBody"></tbody></table></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="passwordModal" class="modal-overlay"><div class="modal-content"><h4 class="text-xl font-bold mb-4">Please enter password</h4><form id="password-form" class="space-y-4"><input id="password-input" type="password" class="w-full" required><div class="flex justify-end gap-2"><button type="button" id="cancel-password-btn" class="btn btn-secondary">Cancel</button><button type="submit" class="btn btn-primary">Confirm</button></div></form></div></div>
    <div id="confirmationModal" class="modal-overlay"><div class="modal-content"><h4 id="modalTitle" class="text-xl font-bold mb-4"></h4><p id="modalMessage" class="text-gray-700 mb-6"></p><div class="flex justify-center gap-4"><button id="confirmActionButton" class="btn btn-danger">Confirm</button><button id="cancelActionButton" class="btn btn-secondary">Cancel</button></div></div></div>
    
    <!-- Rename Project Modal -->
    <div id="renameModal" class="modal-overlay"><div class="modal-content"><h4 id="renameModalTitle" class="text-xl font-bold mb-4">Rename Project</h4><form id="rename-form" class="space-y-4"><input id="rename-input" type="text" class="w-full" required><div class="flex justify-end gap-2"><button type="button" id="cancel-rename-btn" class="btn btn-secondary">Cancel</button><button type="submit" class="btn btn-primary">Rename</button></div></form></div></div>

    <!-- Customize Labels Modal -->
    <div id="customizeLabelsModal" class="modal-overlay">
        <div class="modal-content">
            <h4 class="text-xl font-bold mb-4">Customize Labels</h4>
            <form id="customize-labels-form" class="space-y-4">
                <div>
                    <label for="employeeIdLabelInput" class="block text-sm font-medium text-gray-700 mb-1">Employee ID Label</label>
                    <input type="text" id="employeeIdLabelInput" class="w-full" placeholder="Employee ID">
                </div>
                <div>
                    <label for="surveyIdLabelInput" class="block text-sm font-medium text-gray-700 mb-1">Survey ID Label</label>
                    <input type="text" id="surveyIdLabelInput" class="w-full" placeholder="Survey ID">
                </div>
                <div class="flex justify-end gap-2">
                    <button type="button" id="cancelCustomizeLabelsBtn" class="btn btn-secondary">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Labels</button>
                </div>
            </form>
        </div>
    </div>

    <div id="messageBox"></div><div id="loadingSpinner"><i class="fas fa-spinner fa-spin"></i><span>Loading...</span></div>
    
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        // --- CONSTANTS AND GLOBAL VARIABLES --- //
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwZ5OAvjvi2vVbE1XGIF8-3m7nz0PzrBHw9kNWmiBhs_cay3vVCBCtOWaF9zquH7mHt/exec'; 
        
        let map, currentMarker = null, permanentMarkers = L.layerGroup(), permanentMarkersMap = {}, currentLat = null, currentLng = null, editingId = null, editingMarker = null;
        let dashboardMap;
        let savedLocations = []; // Data from Google Sheet
        let pendingLocations = []; // Data waiting to be uploaded
        let currentProjectName = null;
        let confirmActionCallback = null; // To hold the confirmation callback
        let isIdFieldEditing = false;
        let allProjects = []; // Store all fetched projects
        let idFieldData = [
            {id: 345, name: 'Sumalee Manosong'},
            {id: 399, name: 'Panjapon Deemun'},
            {id: 450, name: 'Nutra Bislimin'},
            {id: 452, name: 'La-ongdao Sriapai'},
            {id: 456, name: 'Piyamas Kanha'},
            {id: 766, name: 'Pornthip Promngam'},
            {id: 781, name: 'Thanyarat Kasemrat'},
            {id: 790, name: 'Darunee Sripen'},
            {id: 797, name: 'Sutheera Pimpat'},
            {id: 839, name: 'Ampha Wunmaesod'},
            {id: 855, name: 'Panisara Phutongchai'},
            {id: 856, name: 'Pornwadee Boonkaewsue'},
            {id: 857, name: 'Sawanya Jariya'},
            {id: 861, name: 'Pornpimon Pasuk'},
            {id: 862, name: 'Teeraporn Meengao'},
            {id: 863, name: 'Premruethai Boonyok'},
            {id: 864, name: 'Arisa Sukhom'},
            {id: 865, name: 'Sukanyarat Khotpoom'}
        ];

        // Custom labels state
        let customLabels = JSON.parse(localStorage.getItem('customLabels')) || {
            employeeId: 'Employee ID',
            surveyId: 'Survey ID'
        };

        // --- DOM ELEMENT SELECTORS --- //
        const allViews = document.querySelectorAll(".app-view");
        const projectSelectionView = document.getElementById("project-selection-view"),
            adminMenuView = document.getElementById("admin-menu-view"),
            dashboardView = document.getElementById("dashboard-view"),
            idFieldView = document.getElementById("id-field-view"),
            trackerView = document.getElementById("tracker-view"),
            adminView = document.getElementById("admin-view"),
            projectList = document.getElementById("project-list"),
            projectCount = document.getElementById("project-count"),
            projectSearchInput = document.getElementById("project-search-input"),
            homeButton = document.getElementById("home-button"),
            trackerTitle = document.getElementById("tracker-title"),
            loadingSpinner = document.getElementById("loadingSpinner"),
            messageBox = document.getElementById("messageBox"),
            savedLocationsTableBody = document.getElementById("savedLocationsTableBody"),
            employeeIdInput = document.getElementById("employeeIdInput"),
            surveyIdInput = document.getElementById("surveyIdInput"),
            locationSearchInput = document.getElementById("locationSearchInput"),
            clearSearchIcon = document.getElementById("clearSearchIcon"),
            autocompleteList = document.getElementById("autocompleteList"),
            confirmationModal = document.getElementById("confirmationModal"),
            modalTitle = document.getElementById("modalTitle"),
            modalMessage = document.getElementById("modalMessage"),
            confirmActionButton = document.getElementById("confirmActionButton"),
            cancelActionButton = document.getElementById("cancelActionButton"),
            confirmEditButton = document.getElementById("confirmEditButton"),
            cancelEditButton = document.getElementById("cancelEditButton"),
            editActionButtonsDiv = document.getElementById("editActionButtons"),
            normalActionButtonsDiv = document.getElementById("normalActionButtons"),
            searchLocationButton = document.getElementById("searchLocationButton"),
            currentLocationButton = document.getElementById("currentLocationButton"),
            saveButton = document.getElementById("saveButton"),
            uploadButton = document.getElementById("uploadButton"),
            exportCsvButton = document.getElementById("exportCsvButton"),
            manageProjectsBtn = document.getElementById("manage-projects-btn"),
            backToMenuBtn = document.getElementById("back-to-menu-btn"),
            menuBackToSelectionBtn = document.getElementById("menu-back-to-selection-btn"),
            gotoManageProjectsBtn = document.getElementById("goto-manage-projects-btn"),
            gotoDashboardsBtn = document.getElementById("goto-dashboards-btn"),
            gotoIdFieldBtn = document.getElementById("goto-id-field-btn"),
            idFieldBackToMenuBtn = document.getElementById("id-field-back-to-menu-btn"),
            editIdFieldBtn = document.getElementById("edit-id-field-btn"),
            saveIdFieldBtn = document.getElementById("save-id-field-btn"),
            cancelIdFieldBtn = document.getElementById("cancel-id-field-btn"),
            idFieldTableBody = document.getElementById("id-field-table-body"),
            idFieldSearchInput = document.getElementById("id-field-search"),
            dashboardBackToMenuBtn = document.getElementById("dashboard-back-to-menu-btn"),
            dashboardProjectSelector = document.getElementById("dashboard-project-selector"),
            dashboardContent = document.getElementById("dashboard-content"),
            dashboardPlaceholder = document.getElementById("dashboard-placeholder"),
            kpiTotalCheckins = document.getElementById("kpi-total-checkins"),
            kpiUniqueEmployees = document.getElementById("kpi-unique-employees"),
            dashboardSummaryTable = document.getElementById("dashboard-summary-table"),
            addProjectForm = document.getElementById("add-project-form"),
            newProjectNameInput = document.getElementById("new-project-name"),
            adminProjectList = document.getElementById("admin-project-list"),
            passwordModal = document.getElementById("passwordModal"),
            passwordForm = document.getElementById("password-form"),
            passwordInput = document.getElementById("password-input"),
            cancelPasswordBtn = document.getElementById("cancel-password-btn"),
            renameModal = document.getElementById("renameModal"),
            renameModalTitle = document.getElementById("renameModalTitle"),
            renameForm = document.getElementById("rename-form"),
            renameInput = document.getElementById("rename-input"),
            cancelRenameBtn = document.getElementById("cancel-rename-btn"),
            customizeLabelsBtn = document.getElementById("customizeLabelsBtn"),
            customizeLabelsModal = document.getElementById("customizeLabelsModal"),
            customizeLabelsForm = document.getElementById("customize-labels-form"),
            employeeIdLabelInput = document.getElementById("employeeIdLabelInput"),
            surveyIdLabelInput = document.getElementById("surveyIdLabelInput"),
            cancelCustomizeLabelsBtn = document.getElementById("cancelCustomizeLabelsBtn"),
            employeeIdLabelElement = document.getElementById("employeeIdLabel"),
            surveyIdLabelElement = document.getElementById("surveyIdLabel");


        // --- LEAFLET ICONS --- //
        const redIcon = new L.Icon({ iconUrl: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png", shadowUrl: "https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png", iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41] }),
            blueIcon = new L.Icon({ iconUrl: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png", shadowUrl: "https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png", iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41] }),
            yellowIcon = new L.Icon({ iconUrl: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-yellow.png", shadowUrl: "https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png", iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41] }),
            greenIcon = new L.Icon({ iconUrl: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png", shadowUrl: "https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png", iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41] });

        // --- UI & VIEW MANAGEMENT --- //
        function showView(viewId) {
            allViews.forEach(v => v.classList.remove("active"));
            document.getElementById(viewId).classList.add("active");
             if (viewId === 'dashboard-view') {
                 setTimeout(() => {
                     if (dashboardMap) dashboardMap.invalidateSize();
                 }, 10);
             }
            if (viewId === 'tracker-view' || viewId === 'project-selection-view' || viewId === 'dashboard-view') {
                updateAllLabels();
            }
        }

        function showSpinner(show) {
            loadingSpinner.style.display = show ? "flex" : "none";
        }

        function showMessage(msg, type = "info") {
            messageBox.textContent = msg;
            messageBox.className = "fixed top-1 left-1/2 -translate-x-1/2 z-[9999] px-5 py-3 rounded-lg shadow-md text-base font-medium flex items-center gap-2";
            messageBox.style.display = "flex";
            const colors = {
                success: ["bg-green-100", "text-green-800"],
                error: ["bg-red-100", "text-red-800"],
                warning: ["bg-yellow-100", "text-yellow-800"],
                info: ["bg-blue-100", "text-blue-800"]
            };
            messageBox.classList.add(...(colors[type] || colors.info));
            setTimeout(() => { messageBox.style.display = "none"; }, 3000);
        }

        function showConfirmation(title, message, onConfirm) {
            modalTitle.textContent = title;
            modalMessage.innerHTML = message;
            confirmActionCallback = onConfirm;
            confirmationModal.style.display = "flex";
        }

        function hideConfirmation() {
            confirmationModal.style.display = "none";
            confirmActionCallback = null;
        }

        // --- MAP FUNCTIONS --- //
        function initializeMap() {
            if (!map) {
                map = L.map("map").setView([13.7563, 100.5018], 6);
                L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { attribution: "© OpenStreetMap contributors" }).addTo(map);
                permanentMarkers.addTo(map);
                map.on("click", e => updateCurrentMarker(e.latlng.lat, e.latlng.lng));
            }
        }
        
        function initializeDashboardMap() {
            if (!dashboardMap) {
                dashboardMap = L.map("dashboard-map").setView([13.7563, 100.5018], 5);
                L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { attribution: "© OpenStreetMap contributors" }).addTo(dashboardMap);
            }
        }

        function updateCurrentMarker(lat, lng) {
            if (currentMarker) {
                currentMarker.setLatLng([lat, lng]);
            } else {
                currentMarker = L.marker([lat, lng], { icon: redIcon }).addTo(map);
            }
            currentLat = lat;
            currentLng = lng;
            document.getElementById("lat").textContent = lat.toFixed(6);
            document.getElementById("lng").textContent = lng.toFixed(6);
        }

        function hideCurrentMarker() {
            if (currentMarker) {
                map.removeLayer(currentMarker);
                currentMarker = null;
            }
            currentLat = null;
            currentLng = null;
            document.getElementById("lat").textContent = "--";
            document.getElementById("lng").textContent = "--";
        }

        // --- DATA RENDERING --- //
        function renderAll() {
            const allLocations = [...savedLocations, ...pendingLocations];
            renderPermanentMarkers(allLocations);
            renderTable(allLocations);
        }

        function renderPermanentMarkers(locations) {
            permanentMarkers.clearLayers();
            permanentMarkersMap = {};
            locations.forEach(loc => {
                if (loc.Latitude && loc.Longitude) {
                    const icon = loc.isPending ? greenIcon : blueIcon;
                    const marker = L.marker([loc.Latitude, loc.Longitude], { icon: icon }).addTo(permanentMarkers).bindPopup(`<b>${customLabels.employeeId}:</b> ${loc.EmployeeID}<br><b>Timestamp:</b> ${new Date(loc.Timestamp).toLocaleString("en-US")}`);
                    permanentMarkersMap[loc.ID] = marker;
                }
            });
        }

        function renderTable(locations) {
            savedLocationsTableBody.innerHTML = "";
            if (locations.length === 0) {
                savedLocationsTableBody.innerHTML = `<tr><td colspan="6" class="py-4 px-4 text-gray-500 text-center">No saved locations yet.</td></tr>`;
                return;
            }
            const sortedLocations = locations.slice().sort((a, b) => new Date(a.Timestamp) - new Date(b.Timestamp));
            sortedLocations.forEach((loc, index) => {
                const row = document.createElement("tr");
                row.dataset.id = loc.ID;
                
                const pendingIndicator = loc.isPending ? '<i class="fas fa-clock pending-icon" title="Pending Upload"></i>' : '';
                const timestamp = loc.Timestamp ? new Date(loc.Timestamp).toLocaleString("en-US") : "Invalid Date";

                row.innerHTML = `
                    <td>${index+1}</td>
                    <td>${loc.EmployeeID} ${pendingIndicator}</td>
                    <td>${loc.SurveyID || '-'}</td>
                    <td>${timestamp}</td>
                    <td><a href="${loc.GoogleMapsLink}" target="_blank" class="text-blue-600 hover:underline text-sm p-1" title="View on Google Maps"><i class="fas fa-map-marker-alt"></i></a></td>
                    <td class="space-x-2">
                        <button class="edit-btn bg-yellow-500 hover:bg-yellow-600 text-white p-1 rounded-lg text-xs" title="Edit"><i class="fas fa-edit"></i></button>
                        <button class="delete-btn bg-red-500 hover:bg-red-600 text-white p-1 rounded-lg text-xs" title="Delete"><i class="fas fa-trash"></i></button>
                    </td>
                    <td class="hidden-col">${loc.ID}</td>`;

                row.querySelector(".edit-btn").addEventListener("click", () => editLocation(loc.ID));
                row.querySelector(".delete-btn").addEventListener("click", () => deleteLocation(loc.ID, loc.EmployeeID));
                
                savedLocationsTableBody.appendChild(row);
            });
        }

        // --- API & DATA HANDLING --- //
        async function apiRequest(url, options = {}) {
            showSpinner(true);
            try {
                if (url.includes('YOUR_NEW_GOOGLE_SCRIPT_URL_HERE')) {
                    throw new Error("Please update WEB_APP_URL in the script.");
                }
                const response = await fetch(url, options);
                if (!response.ok) throw new Error(`Server Error: ${response.status}`);
                const result = await response.json();
                
                if (!result.success && result.status !== 'success') {
                    let errorMessage = result.message;
                    // Special handling for password verification failure without a specific message
                    if (options.body) {
                        try {
                            const body = JSON.parse(options.body);
                            if (body.action === 'verifyPassword' && !errorMessage) {
                                errorMessage = "Password verification failed. Please try again.";
                            }
                        } catch(e) { /* Ignore parsing error if body is not JSON */ }
                    }
                    // Generic fallback if no message is still available
                    if (!errorMessage) {
                        errorMessage = "Action failed. The server did not return an error message.";
                    }
                    throw new Error(errorMessage);
                }
                return result;
            } catch (error) {
                console.error("API Request Failed:", error);
                showMessage(`Error: ${error.message}`, "error");
                throw error;
            } finally {
                showSpinner(false);
            }
        }
        
        async function postToAction(payload) {
            return await apiRequest(WEB_APP_URL, {
                method: "POST",
                mode: "cors",
                cache: "no-cache",
                headers: { "Content-Type": "text/plain;charset=utf-8" },
                body: JSON.stringify(payload)
            });
        }

        async function fetchProjects(){
            try{
                // Add a timestamp to prevent caching issues
                const url = `${WEB_APP_URL}?action=getProjects&t=${new Date().getTime()}`;
                const result = await apiRequest(url, { method: "GET", mode: "cors", cache: "no-cache" });
                return result ? result.data : [];
            } catch(e) {
                return [];
            }
        }

        async function fetchProjectData(projectName){
            try{
                const result = await apiRequest(`${WEB_APP_URL}?action=getData&project=${encodeURIComponent(projectName)}`, { method: "GET", mode: "cors", cache: "no-cache" });
                return result ? result.data : [];
            } catch(e) {
                return [];
            }
        }

        async function fetchLocations(projectName){
            try{
                const data = await fetchProjectData(projectName);
                savedLocations = data;
                pendingLocations = []; // Clear pending on fetch
                renderAll();
                showMessage(`Successfully loaded project '${projectName}'.`, "info");
            } catch(e) {
                savedLocations = [];
                pendingLocations = [];
                renderAll();
            }
        }
        
        function saveLocationAction(){
            if(editingId) {
                confirmEdit();
                return;
            }
            if(currentLat === null) {
                showMessage("Please select a location on the map before saving.", "warning");
                return;
            }
            const empId = employeeIdInput.value.trim();
            const surveyId = surveyIdInput.value.trim();

            if (!empId) {
                showMessage("Please enter " + customLabels.employeeId, "warning");
                return;
            }
            
            const newLoc = {
                ID: `pending_${Date.now()}`,
                EmployeeID: empId,
                SurveyID: surveyId,
                Latitude: currentLat,
                Longitude: currentLng,
                Timestamp: new Date().toISOString(),
                GoogleMapsLink: `https://maps.google.com/?q=${currentLat},${currentLng}`,
                isPending: true
            };

            pendingLocations.push(newLoc);
            showMessage(`Saved ${customLabels.employeeId} ${empId}. Please press Upload to send the data.`, "success");
            employeeIdInput.value = "";
            surveyIdInput.value = "";
            hideCurrentMarker();
            renderAll();
        }

        async function uploadPendingLocations() {
            if (pendingLocations.length === 0) {
                showMessage("No data to upload.", "info");
                return;
            }

            const totalToUpload = pendingLocations.length;
            let successCount = 0;

            for (const loc of pendingLocations) {
                const payload = {
                    action: "add",
                    project: currentProjectName,
                    data: {
                        name: loc.EmployeeID,
                        surveyId: loc.SurveyID || '',
                        lat: loc.Latitude,
                        lng: loc.Longitude
                    }
                };
                
                try {
                    const result = await postToAction(payload);
                    if (result && (result.success || result.status === 'success')) {
                        successCount++;
                    }
                } catch (error) {
                    showMessage(`Upload for ${customLabels.employeeId} ${loc.EmployeeID} failed. Successfully uploaded ${successCount} records.`, "error");
                    await fetchLocations(currentProjectName);
                    return; 
                }
            }

            showMessage(`Successfully uploaded ${successCount} of ${totalToUpload} records!`, "success");
            await fetchLocations(currentProjectName);
        }

        function editLocation(id){
            let loc = pendingLocations.find(l => String(l.ID) === String(id));
            if (!loc) {
                loc = savedLocations.find(l => String(l.ID) === String(id));
            }

            if (!loc) return;
            if (editingId) cancelEdit(); 

            editingId = id;

            if (permanentMarkersMap[id]) permanentMarkers.removeLayer(permanentMarkersMap[id]);
            editingMarker = L.marker([loc.Latitude, loc.Longitude], { icon: yellowIcon, draggable: true }).addTo(map);
            editingMarker.on("dragend", e => updateCurrentMarker(e.target.getLatLng().lat, e.target.getLatLng().lng));
            
            map.setView([loc.Latitude, loc.Longitude], map.getZoom() || 14);
            employeeIdInput.value = loc.EmployeeID;
            surveyIdInput.value = loc.SurveyID || '';
            updateCurrentMarker(loc.Latitude, loc.Longitude);
            editActionButtonsDiv.classList.remove("hidden");
            normalActionButtonsDiv.classList.add("hidden");
        }
        
        async function confirmEdit(){
            if(!editingId) return;

            const empId = employeeIdInput.value.trim();
            const surveyId = surveyIdInput.value.trim();

            if (!empId) {
                showMessage("Please enter " + customLabels.employeeId, "warning");
                return;
            }

            if (String(editingId).startsWith('pending_')) {
                const locToUpdate = pendingLocations.find(l => String(l.ID) === String(editingId));
                if (locToUpdate) {
                    locToUpdate.EmployeeID = empId;
                    locToUpdate.SurveyID = surveyId;
                    locToUpdate.Latitude = currentLat;
                    locToUpdate.Longitude = currentLng;
                    locToUpdate.Timestamp = new Date().toISOString();
                    locToUpdate.GoogleMapsLink = `https://maps.google.com/?q=${currentLat},${currentLng}`;
                }
                showMessage(`Updated pending entry for ${customLabels.employeeId} ${empId}.`, "success");
                cancelEdit();
            } else {
                const payload = { 
                    action: "update", 
                    id: editingId, 
                    project: currentProjectName, 
                    data: { 
                        name: empId, 
                        surveyId: surveyId,
                        lat: currentLat, 
                        lng: currentLng 
                    } 
                };
                try {
                    const result = await postToAction(payload);
                    if(result && (result.success || result.status === 'success')){
                        cancelEdit();
                        await fetchLocations(currentProjectName);
                    }
                } catch(error) { /* Handled by apiRequest */ }
            }
        }

        function cancelEdit(){
            if(editingMarker) {
                map.removeLayer(editingMarker);
                editingMarker = null;
            }
            editingId = null;
            hideCurrentMarker();
            employeeIdInput.value = "";
            surveyIdInput.value = "";
            editActionButtonsDiv.classList.add("hidden");
            normalActionButtonsDiv.classList.remove("hidden");
            renderAll();
        }
        
        async function deleteLocation(id, name) {
            const isPending = String(id).startsWith('pending_');
            const loc = isPending 
                ? pendingLocations.find(l => String(l.ID) === String(id))
                : savedLocations.find(l => String(l.ID) === String(id));

            if (!loc) return;

            showConfirmation("Confirm Deletion", `Are you sure you want to delete the entry for <b>${customLabels.employeeId} ${name}</b>?`, async () => {
                if (isPending) {
                    pendingLocations = pendingLocations.filter(p => String(p.ID) !== String(id));
                    renderAll();
                    showMessage("Deleted pending entry.", "info");
                } else {
                    const payload = { action: "delete", project: currentProjectName, id: id };
                    try {
                        const result = await postToAction(payload);
                        if (result && (result.success || result.status === 'success')) await fetchLocations(currentProjectName);
                    } catch (error) { /* Handled */ }
                }
                hideConfirmation();
            });
        }
        
        // --- LOCATION & SEARCH --- //
        function getCurrentLocation(){
            if(editingId) cancelEdit();
            navigator.geolocation.getCurrentPosition(
                pos => {
                    updateCurrentMarker(pos.coords.latitude, pos.coords.longitude);
                    map.setView([pos.coords.latitude, pos.coords.longitude], 15);
                },
                () => showMessage("Could not get current location.", "error"),
                { enableHighAccuracy: true }
            );
        }

        function searchLocation(query){
            if(!query.trim()) return;
            if(editingId) cancelEdit();
            showSpinner(true);
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5`)
                .then(res => res.json())
                .then(data => {
                    if (data && data.length > 0) {
                        const { lat, lon, display_name } = data[0];
                        updateCurrentMarker(parseFloat(lat), parseFloat(lon));
                        map.setView([lat, lon], 13);
                        locationSearchInput.value = display_name;
                        hideAutocomplete();
                    } else {
                        showMessage("Location not found.", "warning");
                    }
                })
                .catch(err => {
                    console.error("Search Error:", err);
                    showMessage("An error occurred during search.", "error");
                })
                .finally(() => showSpinner(false));
        }
        
        // --- UTILITY & PROJECT MANAGEMENT --- //
        function exportToCSV() {
            const allLocations = [...savedLocations, ...pendingLocations];
            if (allLocations.length === 0) return showMessage("No data to export!", "warning");
            
            const headers = `${customLabels.employeeId},${customLabels.surveyId},Latitude,Longitude,Timestamp,Google Maps Link,Status\n`;
            let csvContent = "data:text/csv;charset=utf-8," + headers;
            
            allLocations.forEach(loc => {
                const status = loc.isPending ? "Pending Upload" : "Saved";
                const empId = `"${String(loc.EmployeeID || '').replace(/"/g, '""')}"`;
                const surveyId = `"${String(loc.SurveyID || '').replace(/"/g, '""')}"`;
                const latitude = loc.Latitude;
                const longitude = loc.Longitude;
                
                const timestampLocale = loc.Timestamp ? new Date(loc.Timestamp).toLocaleString("en-US") : "Invalid Date";
                const timestamp = `"${timestampLocale.replace(/"/g, '""')}"`;

                const googleMapsLink = `"${(loc.GoogleMapsLink || '').replace(/"/g, '""')}"`;

                const row = [empId, surveyId, latitude, longitude, timestamp, googleMapsLink, status].join(",");
                csvContent += row + "\n";
            });

            const link = document.createElement("a");
            link.href = encodeURI(csvContent);

            const date = new Date();
            const fileTimestamp = `${date.getFullYear()}${(date.getMonth() + 1).toString().padStart(2, '0')}${date.getDate().toString().padStart(2, '0')}_${date.getHours().toString().padStart(2, '0')}${date.getMinutes().toString().padStart(2, '0')}`;
            link.download = `${currentProjectName}_locations_${fileTimestamp}.csv`;

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        function selectProject(projectName) {
            currentProjectName = projectName;
            trackerTitle.textContent = projectName;
            showView("tracker-view");
            initializeMap();
            fetchLocations(projectName);
        }
        
        function renderProjectCards(projectsToRender) {
            projectList.innerHTML = "";
            projectCount.textContent = `Total Projects: ${projectsToRender.length}`;

            if(projectsToRender.length === 0){
                projectList.innerHTML = `<p class="text-center text-gray-500 py-4">No projects found.</p>`;
                return;
            }
            projectsToRender.forEach(p => {
                const card = document.createElement("div");
                card.className = "project-card p-4 flex items-center space-x-4 cursor-pointer"; 
                card.innerHTML = `
                    <div class="text-3xl text-blue-500"><i class="fas fa-folder-open"></i></div>
                    <h3 class="text-md font-semibold text-gray-700 flex-grow">${p}</h3>
                    <i class="fas fa-chevron-right text-gray-400"></i>
                `;
                card.addEventListener("click", () => selectProject(p));
                projectList.appendChild(card);
            });
        }
        
        function showRenameModal(oldName) {
            renameModalTitle.textContent = `Rename Project '${oldName}'`;
            renameInput.value = oldName;
            renameModal.style.display = "flex";
            renameInput.focus();
            renameInput.select();

            renameForm.onsubmit = async (e) => {
                e.preventDefault();
                const newName = renameInput.value.trim();

                if (!newName || newName === "") {
                    showMessage("New name cannot be empty.", "warning");
                    return;
                }
                if (newName === oldName) {
                    showMessage("New name is the same as the old name.", "info");
                    hideRenameModal();
                    return;
                }

                hideRenameModal();
                try {
                    await postToAction({ 
                        action: "renameProject", 
                        oldProjectName: oldName,
                        newProjectName: newName
                    });
                    showMessage(`Successfully renamed project '${oldName}' to '${newName}'.`, "success");
                    await loadProjectsAndRender();
                } catch (error) { /* Handled by apiRequest */ }
            };
        }

        function hideRenameModal() {
            renameModal.style.display = 'none';
            renameForm.onsubmit = null;
        }


        function renderAdminProjectList(projects) {
            adminProjectList.innerHTML = "";
            document.getElementById('save-project-order-btn').classList.add('hidden');
            if(projects.length === 0){
                adminProjectList.innerHTML = `<p class="text-center text-gray-500">No projects yet.</p>`;
                return;
            }

            projects.forEach(p => {
                const item = document.createElement("div");
                item.className = "project-admin-item flex justify-between items-center p-2 border rounded-lg bg-gray-50 cursor-grab";
                item.draggable = true;
                item.dataset.projectName = p;
                item.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <i class="fas fa-grip-vertical text-gray-400 pointer-events-none"></i>
                        <span class="flex-grow pointer-events-none">${p}</span>
                    </div>
                    <div class="flex items-center space-x-1 flex-shrink-0">
                        <button class="rename-btn btn btn-secondary btn-icon text-xs p-1" title="Rename"><i class="fas fa-pencil-alt"></i></button>
                        <button class="delete-btn btn btn-danger btn-icon text-xs p-1" title="Delete"><i class="fas fa-trash"></i></button>
                    </div>`;

                item.querySelector(".rename-btn").addEventListener("click", () => showRenameModal(p));
                
                const deleteBtn = item.querySelector(".delete-btn");
                deleteBtn.addEventListener("click", () => {
                    showConfirmation(
                        "Confirm Project Deletion",
                        `Are you sure you want to delete the project <b>${p}</b>? This action cannot be undone.`,
                        async () => {
                            hideConfirmation(); // Hide modal immediately
                            try {
                                await postToAction({ action: "deleteProject", projectName: p });

                                // Optimistically update UI without re-fetching
                                allProjects = allProjects.filter(proj => proj !== p);
                                renderAdminProjectList(allProjects);
                                renderProjectCards(allProjects);

                                showMessage(`Project '${p}' deleted successfully.`, 'success');
                            } catch(err) { 
                                // Error is shown by apiRequest, just log it here.
                                console.error(`Failed to delete project ${p}:`, err);
                            }
                        }
                    );
                });
                
                adminProjectList.appendChild(item);
            });
        }

        async function loadProjectsAndRender(){
            try {
                const projects = await fetchProjects();
                allProjects = projects; 
                renderProjectCards(allProjects);
                renderAdminProjectList(allProjects);
            } catch(e){
                console.error("Could not load projects:", e);
                renderProjectCards([]);
                renderAdminProjectList([]);
            }
        }
        
        // --- ID FIELD FUNCTIONS --- //
        function renderIdFieldTable(data = idFieldData) {
            idFieldTableBody.innerHTML = '';
            data.forEach(person => {
                const row = document.createElement('tr');
                const isEditing = isIdFieldEditing;
                row.innerHTML = `
                    <td>${person.id}</td>
                    <td>
                        ${isEditing 
                            ? `<input type="text" value="${person.name}" data-id="${person.id}" class="w-full bg-blue-50" style="font-family: 'Sarabun', sans-serif;">`
                            : `<span style="font-family: 'Sarabun', sans-serif;">${person.name}</span>`
                        }
                    </td>
                `;
                idFieldTableBody.appendChild(row);
            });
        }

        function toggleIdFieldEdit(isEditing) {
            isIdFieldEditing = isEditing;
            idFieldSearchInput.value = '';
            editIdFieldBtn.classList.toggle('hidden', isEditing);
            saveIdFieldBtn.classList.toggle('hidden', !isEditing);
            cancelIdFieldBtn.classList.toggle('hidden', !isEditing);
            renderIdFieldTable();
        }
        
        // --- DASHBOARD FUNCTIONS --- //
        function updateDashboardLabels() {
            const header = document.getElementById('dashboardHeaderIdField');
            if (header) {
                header.textContent = customLabels.employeeId;
            }
        }

        async function initializeDashboardView() {
            updateDashboardLabels();
            initializeDashboardMap();
            const projects = await fetchProjects();
            dashboardProjectSelector.innerHTML = '<option value="">-- Select a Project --</option>';
            projects.forEach(p => {
                const option = document.createElement('option');
                option.value = p;
                option.textContent = p;
                dashboardProjectSelector.appendChild(option);
            });
            dashboardContent.classList.add('hidden');
            dashboardPlaceholder.classList.remove('hidden');
        }

        async function updateDashboard(projectName) {
            if (!projectName) {
                dashboardContent.classList.add('hidden');
                dashboardPlaceholder.classList.remove('hidden');
                return;
            }
            dashboardPlaceholder.classList.add('hidden');
            
            const data = await fetchProjectData(projectName);
            
            kpiTotalCheckins.textContent = data.length;
            const uniqueEmployees = new Set(data.map(d => String(d.EmployeeID))); 
            kpiUniqueEmployees.textContent = uniqueEmployees.size;

            if(dashboardMap) {
                dashboardMap.eachLayer(layer => {
                    if (layer instanceof L.Marker) {
                        dashboardMap.removeLayer(layer);
                    }
                });
                if (data.length > 0) {
                    const markers = L.featureGroup();
                    data.forEach(loc => {
                        if (loc.Latitude && loc.Longitude) {
                           const marker = L.marker([loc.Latitude, loc.Longitude]).addTo(markers);
                           marker.bindPopup(`<b>${customLabels.employeeId}: ${loc.EmployeeID}</b><br>Timestamp: ${new Date(loc.Timestamp).toLocaleString("en-US")}<br>${customLabels.surveyId}: ${loc.SurveyID || '-'}`);
                        }
                    });
                    markers.addTo(dashboardMap);
                    dashboardMap.fitBounds(markers.getBounds().pad(0.1));
                }
            }
            
            dashboardSummaryTable.innerHTML = "";
            const employeeSummary = {};

            data.forEach(loc => {
                const employeeId = String(loc.EmployeeID);
                if (employeeSummary[employeeId]) {
                    employeeSummary[employeeId].count++;
                } else {
                    const numericPrefix = employeeId.match(/^\d{1,3}/);
                    let name = 'Unknown';
                    if (numericPrefix) {
                        const person = idFieldData.find(p => String(p.id) === numericPrefix[0]);
                        if(person) name = person.name;
                    }
                    employeeSummary[employeeId] = { count: 1, name: name };
                }
            });

            if (Object.keys(employeeSummary).length > 0) {
                for (const empId in employeeSummary) {
                    const summary = employeeSummary[empId];
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${empId}</td>
                        <td style="font-family: 'Sarabun', sans-serif;">${summary.name}</td>
                        <td class="text-center">${summary.count}</td>
                    `;
                    dashboardSummaryTable.appendChild(row);
                }
            } else {
                dashboardSummaryTable.innerHTML = `<tr><td colspan="3" class="text-center text-gray-500">No summary data available.</td></tr>`;
            }

            dashboardContent.classList.remove('hidden');
            setTimeout(() => dashboardMap.invalidateSize(), 10);
        }


        // --- AUTOCOMPLETE --- //
        let autocompleteTimeout;
        function setupAutocomplete() {
            locationSearchInput.addEventListener("input", e => {
                const query = e.target.value.trim();
                clearSearchIcon.style.display = query.length > 0 ? "block" : "none";
                clearTimeout(autocompleteTimeout);
                if (query.length > 2) { 
                    autocompleteTimeout = setTimeout(() => {
                        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5&countrycodes=th`)
                            .then(res => res.json())
                            .then(data => showAutocomplete(data));
                    }, 300);
                } else {
                    hideAutocomplete();
                }
            });
        }
        function showAutocomplete(items) {
            autocompleteList.innerHTML = "";
            if (!items || items.length === 0) {
                hideAutocomplete();
                return;
            }
            items.forEach(item => {
                const div = document.createElement("div");
                div.className = "p-2 hover:bg-gray-100 cursor-pointer text-sm";
                div.textContent = item.display_name;
                div.addEventListener("click", () => searchLocation(item.display_name));
                autocompleteList.appendChild(div);
            });
            autocompleteList.classList.remove("hidden");
        }
        function hideAutocomplete() {
            autocompleteList.classList.add("hidden");
        }
        
        // --- CUSTOM LABEL FUNCTIONS --- //
        function updateAllLabels() {
            employeeIdLabelElement.textContent = customLabels.employeeId;
            surveyIdLabelElement.textContent = customLabels.surveyId;
            employeeIdInput.placeholder = customLabels.employeeId;
            surveyIdInput.placeholder = customLabels.surveyId;
            const tableHeaderEmployeeId = document.getElementById('tableHeaderEmployeeId');
            if (tableHeaderEmployeeId) tableHeaderEmployeeId.textContent = customLabels.employeeId;
            const tableHeaderSurveyId = document.getElementById('tableHeaderSurveyId');
            if (tableHeaderSurveyId) tableHeaderSurveyId.textContent = customLabels.surveyId;
            updateDashboardLabels();
        }

        function showCustomizeLabelsModal() {
            employeeIdLabelInput.value = customLabels.employeeId;
            surveyIdLabelInput.value = customLabels.surveyId;
            customizeLabelsModal.style.display = "flex";
        }

        function hideCustomizeLabelsModal() {
            customizeLabelsModal.style.display = "none";
        }

        function saveCustomLabels() {
            customLabels.employeeId = employeeIdLabelInput.value.trim() || 'Employee ID';
            customLabels.surveyId = surveyIdLabelInput.value.trim() || 'Survey ID';
            localStorage.setItem('customLabels', JSON.stringify(customLabels));
            updateAllLabels();
            hideCustomizeLabelsModal();
            showMessage("Labels updated successfully!", "success");
        }

        // --- EVENT LISTENERS SETUP --- //
        function setupEventListeners(){
            saveButton.addEventListener("click", saveLocationAction);
            uploadButton.addEventListener("click", uploadPendingLocations);
            exportCsvButton.addEventListener("click", exportToCSV);
            
            confirmEditButton.addEventListener("click", confirmEdit);
            cancelEditButton.addEventListener("click", cancelEdit);

            confirmActionButton.addEventListener("click", () => {
                if (typeof confirmActionCallback === 'function') {
                    confirmActionCallback();
                }
            });
            cancelActionButton.addEventListener("click", hideConfirmation);

            currentLocationButton.addEventListener("click", getCurrentLocation);
            searchLocationButton.addEventListener("click", () => searchLocation(locationSearchInput.value));
            locationSearchInput.addEventListener("keydown", e => {
                if (e.key === "Enter") {
                    e.preventDefault();
                    searchLocation(locationSearchInput.value);
                }
            });
            clearSearchIcon.addEventListener("click", () => {
                locationSearchInput.value = "";
                clearSearchIcon.style.display = "none";
                hideAutocomplete();
                locationSearchInput.focus();
            });
            document.addEventListener("click", e => {
                if (!e.target.closest("#autocompleteList") && !e.target.closest("#locationSearchInput") && autocompleteList.classList.contains("active")) {
                    hideAutocomplete();
                }
            });
            homeButton.addEventListener("click", () => {
                showView("project-selection-view");
                loadProjectsAndRender();
            });
            
            manageProjectsBtn.addEventListener("click", () => {
                passwordModal.style.display = "flex";
                passwordInput.focus();
            });
            menuBackToSelectionBtn.addEventListener("click", () => {
                showView("project-selection-view");
            });
            gotoManageProjectsBtn.addEventListener("click", () => {
                showView("admin-view");
            });
            gotoDashboardsBtn.addEventListener("click", () => {
                initializeDashboardView();
                showView("dashboard-view");
            });
            gotoIdFieldBtn.addEventListener("click", () => {
                renderIdFieldTable();
                showView("id-field-view");
            });
            idFieldBackToMenuBtn.addEventListener("click", () => {
                showView("admin-menu-view");
            });
            dashboardBackToMenuBtn.addEventListener("click", () => {
                showView("admin-menu-view");
            });
            backToMenuBtn.addEventListener("click", () => {
                showView("admin-menu-view");
            });
            dashboardProjectSelector.addEventListener('change', (e) => {
                updateDashboard(e.target.value);
            });
            
            editIdFieldBtn.addEventListener('click', () => toggleIdFieldEdit(true));
            cancelIdFieldBtn.addEventListener('click', () => toggleIdFieldEdit(false)); 
            saveIdFieldBtn.addEventListener('click', () => {
                const inputs = idFieldTableBody.querySelectorAll('input[type="text"]');
                inputs.forEach(input => {
                    const idToUpdate = input.dataset.id;
                    const person = idFieldData.find(p => String(p.id) === idToUpdate);
                    if (person) {
                        person.name = input.value;
                    }
                });
                toggleIdFieldEdit(false);
                showMessage("Names updated successfully.", "success");
            });
            idFieldSearchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const filteredData = idFieldData.filter(person => {
                    return String(person.id).includes(searchTerm) || person.name.toLowerCase().includes(searchTerm);
                });
                renderIdFieldTable(filteredData);
            });


            addProjectForm.addEventListener("submit", async e => {
                e.preventDefault();
                const newName = newProjectNameInput.value.trim();
                if (newName) {
                    try {
                        await postToAction({ action: "addProject", projectName: newName });
                        newProjectNameInput.value = "";
                        await loadProjectsAndRender();
                    } catch(err) { /* Handled */ }
                }
            });

            passwordForm.addEventListener("submit", async (e) => {
                e.preventDefault();
                const enteredPassword = passwordInput.value;
                if (!enteredPassword) return;
                
                passwordInput.value = ""; 

                try {
                    const result = await postToAction({ 
                        action: "verifyPassword", 
                        password: enteredPassword 
                    });

                    if (result.success || result.status === 'success') {
                        passwordModal.style.display = "none";
                        showView("admin-menu-view");
                    } else {
                        showMessage(result.message || "Incorrect password", "error");
                        passwordInput.focus();
                        passwordInput.select();
                    }
                } catch (error) {
                    console.error("Password verification failed:", error);
                    passwordInput.focus();
                    passwordInput.select();
                }
            });
            
            cancelPasswordBtn.addEventListener("click", () => {
                passwordModal.style.display = "none";
                passwordInput.value = "";
            });

            cancelRenameBtn.addEventListener("click", hideRenameModal);

            projectSearchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const filteredProjects = allProjects.filter(p => p.toLowerCase().includes(searchTerm));
                renderProjectCards(filteredProjects);
            });

            customizeLabelsBtn.addEventListener("click", showCustomizeLabelsModal);
            cancelCustomizeLabelsBtn.addEventListener("click", hideCustomizeLabelsModal);
            customizeLabelsForm.addEventListener("submit", (e) => {
                e.preventDefault();
                saveCustomLabels();
            });

            const adminProjectListContainer = document.getElementById('admin-project-list');
            let draggedItem = null;

            adminProjectListContainer.addEventListener('dragstart', e => {
                if (e.target.classList.contains('project-admin-item')) {
                    draggedItem = e.target;
                    setTimeout(() => {
                        draggedItem.classList.add('dragging');
                    }, 0);
                }
            });

            adminProjectListContainer.addEventListener('dragend', e => {
                if (draggedItem) {
                    draggedItem.classList.remove('dragging');
                    draggedItem = null;
                }
            });

            adminProjectListContainer.addEventListener('dragover', e => {
                e.preventDefault(); 
                if (draggedItem) {
                    const afterElement = getDragAfterElement(adminProjectListContainer, e.clientY);
                    if (afterElement == null) {
                        adminProjectListContainer.appendChild(draggedItem);
                    } else {
                        adminProjectListContainer.insertBefore(draggedItem, afterElement);
                    }
                }
            });

            adminProjectListContainer.addEventListener('drop', e => {
                e.preventDefault();
                if(draggedItem) {
                    document.getElementById('save-project-order-btn').classList.remove('hidden');
                }
            });

            function getDragAfterElement(container, y) {
                const draggableElements = [...container.querySelectorAll('.project-admin-item:not(.dragging)')];

                return draggableElements.reduce((closest, child) => {
                    const box = child.getBoundingClientRect();
                    const offset = y - box.top - box.height / 2;
                    if (offset < 0 && offset > closest.offset) {
                        return { offset: offset, element: child };
                    } else {
                        return closest;
                    }
                }, { offset: Number.NEGATIVE_INFINITY }).element;
            }

            document.getElementById('save-project-order-btn').addEventListener('click', async () => {
                const projectItems = document.querySelectorAll('#admin-project-list .project-admin-item');
                const newProjectOrder = Array.from(projectItems).map(item => item.dataset.projectName);

                try {
                    await postToAction({ action: 'reorderProjects', projectOrder: newProjectOrder });
                    showMessage('Project order updated successfully.', 'success');
                    document.getElementById('save-project-order-btn').classList.add('hidden');
                    await loadProjectsAndRender();
                } catch(err) { /* Error already handled */ }
            });

            setupAutocomplete();
        }
        
        // --- APP INITIALIZATION --- //
        window.onload = () => {
            setupEventListeners();
            loadProjectsAndRender();
            showView("project-selection-view");
            updateAllLabels();
        };
    </script>
</body>
</html>
